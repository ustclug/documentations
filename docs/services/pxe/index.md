# PXE

对校园网用户与校外用户公开的 PXE 服务。LIIMS 与目前的 PXE 虽然运行在同一台服务器上，但是配置有所不同。

!!! todo "本文档需要大幅扩充"

## Intro

<https://lug.ustc.edu.cn/wiki/server/pxe/>

<https://lug.ustc.edu.cn/planet/2018/10/PXE-intro/>

!!! info "关于 FAQ"

    <https://lug.ustc.edu.cn/wiki/server/pxe/faq/> 实在是年头太久远了，无法更新。新的内容记录在本文档中。

一般的启动流程是：

1. iPXE，或者主板上获取的 DHCP 启动信息的固件下载并加载 GRUB 相关文件。
2. 如果 MAC 地址不为指定值，那么加载菜单并显示；然后加载 Linux 内核与 initramfs 等事项由 GRUB 负责。
3. Initramfs 从启动参数挂载 NFS 为 rootfs，进行下一步的启动。

## 使用/调试

PXE 在校园网中直接可用，因为学校的 DHCP 服务器经过了配置。

如果需要在虚拟机中调试，可以：

- 下载 IPXE 的 ISO（<http://boot.ipxe.org/ipxe.iso>），挂载在虚拟机中测试。
- 或者直接使用打包后的 ISO：<https://ftp.lug.ustc.edu.cn/PXE/image/ustc.ipxe.iso>

!!! note "推荐使用的虚拟机方案"

    PXE 能够成功运行与否有可能和虚拟机环境（特别是虚拟网卡型号）高度相关。推荐使用 QEMU。

其中主要使用的是基于 GRUB2 和 simple-pxe 的新 PXE 方案。主板固件使用 TFTP 协议获取 GRUB2 程序（core.0 或者 core.efi）之后，GRUB2 会通过 HTTP 协议获取剩下所有的文件。

!!! note "TFTP"

    和 FTP active 模式一样，TFTP 是一个有点麻烦的协议，如果你的虚拟机无法不经过 NAT 连接 PXE 服务器，那么就需要调整网络配置，会很麻烦，再加上对校外访问需求的考量，因此目前的考虑是尽量使用 HTTP。

基于 SYSLINUX 的老 PXE 方案（lpxelinux.0 -> bin/lpxelinux.0）目前仍可启动，但是不使用。

### SYSLINUX 更新

虽然不维护了，但是以下内容仍作记录：

```shell
wget https://mirrors.ustc.edu.cn/fedora/releases/40/Everything/x86_64/os/Packages/s/syslinux-tftpboot-6.04-0.26.fc40.noarch.rpm
# decompress
rpm2cpio syslinux-tftpboot-6.04-0.26.fc40.noarch.rpm | cpio -idmv
cd tftpboot
ln -s lpxelinux.0 pxelinux.0
ln -s lpxelinux.0 undionly.kpxe
```

得到的 tftpboot 目录替代原先的 tftp/bin 目录。启动 VM 的时候可以 Wireshark 看看它下载了哪些文件。同时还有个 `pxeknife`，目前只在 SYSLINUX 的 PXE 方案中可用。

!!! todo "pypxe"

    pypxe 似乎只在 SYSLINUX 方案中使用。

### 使用 UEFI 直接启动

QEMU 一般使用的 UEFI 固件 OVMF 支持直接从 HTTP 启动。在写作时，Arch Linux 打包的 OVMF 没编译此特性，其他的发行版也有可能不支持，因此需要：

1. 从 <https://www.kraxel.org/repos/jenkins/edk2/> 下载 x64 版本的 rpm 并解压
2. 然后使用以下命令启动 QEMU：

    ```shell
    qemu-system-x86_64 -L . --bios ../ovmf-x64/OVMF-pure-efi.fd
    ```

    启动后马上按下 ESC，进入配置界面，然后阅读 <https://github.com/tianocore/tianocore.github.io/wiki/HTTP-Boot> 做进一步配置。

### 制作 GRUB2 镜像

旧版本的 GRUB2 可能有 bug（例如 <https://github.com/ustclug/discussions/issues/456>），因此有时候需要升级。

更新策略考虑使用 Debian stable 的 grub2。启动容器并且将外面的目录 bind mount：

```shell
docker run -it --rm -v $(pwd)/tftp:/srv/tftp ustclug/debian:12
```

然后在容器中执行：

```shell
apt update && apt install grub-common grub-pc grub-efi-amd64-signed
grub-mknetdir
grub-mkimage -d /usr/lib/grub/i386-pc -O i386-pc-pxe -o /srv/tftp/boot/grub/i386-pc/core.0 -p '(http,202.38.93.94)/boot/tftp/grub/' pxe http
grub-mkimage -d /usr/lib/grub/x86_64-efi -O x86_64-efi -o /srv/tftp/boot/grub/x86_64-efi/core.efi -p '(http,202.38.93.94)/boot/tftp/grub/' efinet http
```

最后两个 `grub-mkimage` 是因为 `grub-mknetdir` 生成的镜像使用 tftp 协议，在调试时可能会有问题。我们希望 GRUB2 能够全程使用 HTTP 做剩下的工作。

更换文件的时候**别把配置覆盖了**。

### 构建 iPXE ISO

参考 <https://ipxe.org/embed>。

```ipxe
#!ipxe

# Generated by GPT-4
dhcp
set 210:string http://202.38.93.94/boot/tftp/

# UEFI boot?
iseq ${platform} efi && goto uefi || goto bios

:uefi
echo "UEFI boot detected"
chain ${210:string}bootx64.efi
exit

:bios
echo "BIOS boot detected"
chain ${210:string}pxelinux.0
exit
```

clone ipxe/ipxe 仓库，进入 src 目录，然后执行：

```shell
# https://github.com/ipxe/ipxe/pull/50
make bin-x86_64-efi/ipxe.efi bin/ipxe.lkrn
./util/genfsimg -o ustc.ipxe.iso -s ../../ustc.ipxe bin-x86_64-efi/ipxe.efi bin/ipxe.lkrn
```

## 架构

新 PXE 方案的 HTTP 服务器为 Apache + Nginx。URL 中的 boot2 对应 /nfsroot/pxe。

!!! todo "处理 web 服务器"

    目前 PXE 机器的 web 服务器有点诡异，Apache2 监听 80，Nginx 监听 443，后续需要调整处理。

!!! todo "文件跳转配置"

    Apache2 中配置了一些 alias 跳转，同样的，TFTP 也有类似的配置（`/etc/xinetd.d/tftp` 的 `server_args` 里面有 `-m /home/pxe/tftp/REMAP`）。

    需要检查一致性。

如果出现问题需要调试，建议抓包（可以使用 Wireshark 查看 TFTP 或 HTTP 协议）看是否正常。

每天凌晨，pxe 用户的 crontab 任务会执行 <https://github.com/ustclug/simple-pxe/blob/master/simple-pxe-in-docker>（文件位于 pxe 用户的 home 中），实现 PXE 相关文件的更新。

## 故障 {#faults}

pxe 服务器在升级到 Debian Bullseye (11) 后无法正常开机，经过 GRUB 进入内核后每 5 秒刷出以下信息：

```text
DMAR: DRHD: handling fault status reg 2
DMAR: [DMA Read] Request device [03:00.0] PASID ffffffff fault addr cb2f0000 [fault reason 06] PTE Read access is not set
DMAR: DRHD: handling fault status reg 102
```

由于此时刚升级至 Debian Bullseye，所以系统仍然保留了 Debian Buster 的 4.19 版内核。重启进该内核可正常启动并运行服务，但只要进 5.10 的内核就会出现以上错误。测试 Proxmox VE 提供的 pve-kernel-5.15 也是同样问题。

搜索发现主机使用的 RAID 卡 PERC H310 不支持直通（IOMMU 虚拟化），配置 GRUB 加入 `intel_iommu=off` 后可以正常进入 5.10 的内核，作为解决方案。

??? info "调查结果"

    按说 IOMMU（VT-d）不应该默认启用，因此猜测 5.10+ 的内核会主动尝试开启 IOMMU，导致 RAID 卡出错。

    比较 `/boot/config-4.19.0-18-amd64` 和 `/boot/config-5.10.0-11-amd64` 后发现 5.10 版的 config 多了一行 `CONFIG_INTEL_IOMMU_DEFAULT_ON_INTGPU_OFF=y`，搜索发现 [Debian bug #932086](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=932086)，即 Debian 默认对除了 Intel GPU 以外的设备启用 IOMMU（`linux 5.2.9-2`）。

参考链接：

- [DELLR730 server halts during boot-up when "intel_iommu=on" parameter is enabled in grub for SRIOV functionality. - Dell Community](https://www.dell.com/community/PowerEdge-OS-Forum/DELLR730-server-halts-during-boot-up-when-quot-intel-iommu-on/td-p/4632026)
- [:fontawesome-regular-file-pdf: Dell PowerEdge RAID Controller (PERC) H310, H710, H710P, and H810 - User's Guide](https://hg.flagshiptech.com/ebay/DellManuals/rc_h310_h710_h710p_h810_ug_en-us.pdf)（第 85 页）
